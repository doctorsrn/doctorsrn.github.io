<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="google-site-verification" content="M-d51FT64gQ2RZF72MacGEYBhVCNwc6s5HrcHk7-NU8">














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/5_128.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/2_32.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/1_16.png?v=5.1.4">


  <link rel="mask-icon" href="/images/5_128.ico?v=5.1.4" color="#222">





  <meta name="keywords" content="python,robotics,simulation,v-rep,lua,deep reinforcement learning,">










<meta name="description" content="前言这篇博客主要是记录自己学习和使用机器人仿真软件V-rep过程中的一些知识点和踩的坑。首先从下面两个问题展开：  常用的机器人仿真软件有哪些？为什么选择V-rep？目前常用的机器人物理仿真软件有Gazebo、V-rep、Webots等，这三款都是开源软件，自己使用过前两种，Gazebo配合ROS使用功能十分强大，但是要在Linux系统下使用，会有些不方便；V-rep是一个跨平台的仿真软件，在wi">
<meta name="keywords" content="python,robotics,simulation,v-rep,lua,deep reinforcement learning">
<meta property="og:type" content="article">
<meta property="og:title" content="V-rep机器人仿真软件使用的学习笔记">
<meta property="og:url" content="http://doctorsrn.cn/2019/08/02/V-rep/index.html">
<meta property="og:site_name" content="Hello World">
<meta property="og:description" content="前言这篇博客主要是记录自己学习和使用机器人仿真软件V-rep过程中的一些知识点和踩的坑。首先从下面两个问题展开：  常用的机器人仿真软件有哪些？为什么选择V-rep？目前常用的机器人物理仿真软件有Gazebo、V-rep、Webots等，这三款都是开源软件，自己使用过前两种，Gazebo配合ROS使用功能十分强大，但是要在Linux系统下使用，会有些不方便；V-rep是一个跨平台的仿真软件，在wi">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_0.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_2.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_1.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_3.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_4.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_9.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_7.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_8.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_10.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_5.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_6.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_12.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_13.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_11.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_14.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_15.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_16.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_17.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_18.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_19.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_20.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_21.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_22.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_23.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_24.png">
<meta property="og:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_25.png">
<meta property="og:updated_time" content="2019-08-03T15:40:22.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="V-rep机器人仿真软件使用的学习笔记">
<meta name="twitter:description" content="前言这篇博客主要是记录自己学习和使用机器人仿真软件V-rep过程中的一些知识点和踩的坑。首先从下面两个问题展开：  常用的机器人仿真软件有哪些？为什么选择V-rep？目前常用的机器人物理仿真软件有Gazebo、V-rep、Webots等，这三款都是开源软件，自己使用过前两种，Gazebo配合ROS使用功能十分强大，但是要在Linux系统下使用，会有些不方便；V-rep是一个跨平台的仿真软件，在wi">
<meta name="twitter:image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_0.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://doctorsrn.cn/2019/08/02/V-rep/">





  <title>V-rep机器人仿真软件使用的学习笔记 | Hello World</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?1dfa1c7ff6fb0549819d508771ae03c8";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->




</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hello World</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://doctorsrn.cn/2019/08/02/V-rep/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="SamLiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://raw.githubusercontent.com/doctorsrn/git_test/master/050.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hello World">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">V-rep机器人仿真软件使用的学习笔记</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-02T20:30:22+08:00">
                2019-08-02
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2019-08-03T23:40:22+08:00">
                2019-08-03
              </time>
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/robotics/" itemprop="url" rel="index">
                    <span itemprop="name">robotics</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/08/02/V-rep/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/08/02/V-rep/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/08/02/V-rep/" class="leancloud_visitors" data-flag-title="V-rep机器人仿真软件使用的学习笔记">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  9,385 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  41 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这篇博客主要是记录自己学习和使用机器人仿真软件<a href="http://www.v-rep.eu/" target="_blank" rel="noopener">V-rep</a>过程中的一些知识点和踩的坑。首先从下面两个问题展开：</p>
<ul>
<li>常用的机器人仿真软件有哪些？为什么选择V-rep？<br>目前常用的机器人物理仿真软件有<a href="http://gazebosim.org/" target="_blank" rel="noopener">Gazebo</a>、<a href="http://www.v-rep.eu/" target="_blank" rel="noopener">V-rep</a>、<a href="https://www.cyberbotics.com/" target="_blank" rel="noopener">Webots</a>等，这三款都是开源软件，自己使用过前两种，Gazebo配合ROS使用功能十分强大，但是要在Linux系统下使用，会有些不方便；V-rep是一个跨平台的仿真软件，在windows和Linux下都可以很稳定的运行，而且软件体积较小。考虑到要在windows下使用仿真软件，以及V-rep方便的Python API接口和易用性，最终选择使用V-rep。</li>
<li>V-rep在自己项目的应用情况？<br>自己使用V-rep主要用来进行<strong>机械臂</strong>规划和控制方面算法的验证和仿真实验，主要用于以下两个方面：<ul>
<li>利用V-rep的物理仿真环境，建立类似OpenAI Gym的交互环境，进行基于强化学习的机械臂规划和控制方法方面的仿真实验。</li>
<li>利用V-rep进行双臂机器人协作规划和控制算法研究</li>
</ul>
</li>
</ul>
<p>V-rep中内置了很多商用机械臂模型。如果使用Gazebo，可以搭配ROS Moveit!进行机械臂相关的仿真和实物规划与控制。</p>
<p><strong>PS:</strong> 本文内容对应的V-rep的版本：<strong>V-rep 3.6.1 rev3</strong>， 学习过程有问题可以去<a href="http://www.forum.coppeliarobotics.com/" target="_blank" rel="noopener">V-rep的社区</a>提问，感觉管理者的反馈很快而且很负责任，自己在使用过程去社区报了遇到的BUG，管理员还给自己发邮件确认姓名，说要在新版本的更新log中将自己加入贡献人中，然后在新版本的log中就发现了自己的姓名，还是很开心的~<br><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_0.png" alt="pics1_0"></p>
<h1 id="一、V-rep-基本知识"><a href="#一、V-rep-基本知识" class="headerlink" title="一、V-rep 基本知识"></a>一、V-rep 基本知识</h1><h2 id="1-Tutorials-Building-a-clean-model-tutorial"><a href="#1-Tutorials-Building-a-clean-model-tutorial" class="headerlink" title="1.Tutorials: Building a clean model tutorial"></a>1.Tutorials: Building a clean model tutorial</h2><h3 id="1-1-Building-the-visible-shapes"><a href="#1-1-Building-the-visible-shapes" class="headerlink" title="1.1 Building the visible shapes"></a>1.1 Building the visible shapes</h3><ul>
<li>建议使用的CAD模型包含的triangles少于20000个，这样有利于快速计算</li>
<li>导入CAD模型后使用V-rep进一步简化<ul>
<li>Automatic mesh division: <code>[Menu bar --&gt; Edit --&gt; Grouping/Merging --&gt; Divide selected shapes]</code> 和<code>[Menu bar --&gt; Edit -&gt; Grouping/Merging --&gt; Merge selected shapes]</code></li>
<li>Extract the convex hull: <code>[Menu bar --&gt; Edit --&gt; Morph selection into convex shapes]</code></li>
<li>Decimate the mesh: <code>[Menu bar --&gt; Edit --&gt; Decimate selected shape...]</code></li>
<li>Remove the inside of the mesh: <code>[Menu bar --&gt; Edit --&gt; Extract inside of selected shape]</code></li>
</ul>
</li>
<li>可以再shape属性中查看模型的triangle数</li>
<li>将一个整体模型按照连接关系（关节）分割：<ul>
<li>Automatic mesh division: <code>[Menu bar --&gt; Edit --&gt; Grouping/merging --&gt; Divide selected shapes].</code></li>
<li>Manual mesh division: 通过 <code>triangle edit mode</code>分割</li>
</ul>
</li>
</ul>
<h3 id="1-2-Building-the-joints"><a href="#1-2-Building-the-joints" class="headerlink" title="1.2 Building the joints"></a>1.2 Building the joints</h3><ul>
<li>使用<code>Models/tools/Denavit-Hartenberg joint creator.ttm</code>通过D-H参数创建关节</li>
</ul>
<h3 id="1-3-Building-the-dynamic-shapes"><a href="#1-3-Building-the-dynamic-shapes" class="headerlink" title="1.3 Building the dynamic shapes"></a>1.3 Building the dynamic shapes</h3><h3 id="1-4-Model-definition"><a href="#1-4-Model-definition" class="headerlink" title="1.4 Model definition"></a>1.4 Model definition</h3><h2 id="2-关于V-rep内置Lua脚本的学习"><a href="#2-关于V-rep内置Lua脚本的学习" class="headerlink" title="2.关于V-rep内置Lua脚本的学习"></a>2.<a href="http://www.coppeliarobotics.com/helpFiles/index.html" target="_blank" rel="noopener">关于V-rep内置Lua脚本的学习</a></h2><p><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_2.png" alt="pics1_2"><br><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_1.png" alt="pics1_1"></p>
<p>Lua中的脚本包括：</p>
<ul>
<li><a href="http://www.coppeliarobotics.com/helpFiles/index.html" target="_blank" rel="noopener">main script</a></li>
<li><a href="http://www.coppeliarobotics.com/helpFiles/index.html" target="_blank" rel="noopener">child script</a></li>
</ul>
<p><strong>Tips</strong>：v-rep是默认打开19997端口</p>
<h3 id="2-1-main-script"><a href="#2-1-main-script" class="headerlink" title="2.1 main script"></a>2.1 main script</h3><p><a href="http://www.coppeliarobotics.com/helpFiles/index.html" target="_blank" rel="noopener">main script</a>主脚本相当于主函数，有且只有一个。主脚本由以下几个函数组成：</p>
<ul>
<li>初始化函数sysCall_init:在仿真开始阶段执行一次</li>
<li>执行函数sysCall_actuation:在每个仿真回合都会执行，用于控制所有仿真对象的执行函数。有三个函数比较重要：<ul>
<li>sim.launchThreadedChildScripts</li>
<li>sim.resumeThreads</li>
<li>sim.handleChildScripts</li>
</ul>
</li>
<li>传感器函数sysCall_sensing:在每个仿真回合都会执行，用于控制所有传感器函数。有三个函数比较重要：<ul>
<li>sim.resumeThreads</li>
<li>sim.handleChildScripts</li>
</ul>
</li>
<li>恢复函数sysCall_cleanup:仅在仿真结束时执行一次，用于将仿真环境恢复为仿真开始前的状态。</li>
</ul>
<h3 id="2-2-child-scripts"><a href="#2-2-child-scripts" class="headerlink" title="2.2 child scripts"></a>2.2 child scripts</h3><p><a href="http://www.coppeliarobotics.com/helpFiles/index.html" target="_blank" rel="noopener">child script</a>数量不限，与仿真场景中的物体相关联，被main scripts调用。child script与场景中物体的关联有以下优势：很好的可移植性和继承性、不同版本模型间没有冲突、和仿真循环很好的进行同步。</p>
<p>child script有两种类型 non-threaded child scripts（非线程子脚本） 和threaded child scripts（线程子脚本）：<br><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_3.png" alt="pics1_3"></p>
<h4 id="2-2-1-non-threaded-child-scripts"><a href="#2-2-1-non-threaded-child-scripts" class="headerlink" title="2.2.1 non-threaded child scripts"></a>2.2.1 non-threaded child scripts</h4><p>non-threaded child scripts包含一组阻塞函数，即每次被调用时将执行一些任务，然后返回控制权，如果没有返回则整个仿真一直停滞。每个仿真间隔中non-threaded child scripts将被main script调用两次：main script’s actuation and sensing 。<br><strong>Tip</strong>：优先选择non-threaded child scripts来写子脚本。</p>
<p>non-threaded child scripts应当被分为4个函数来写：</p>
<ul>
<li>初始化函数sysCall_init：仅在child script被调用时执行一次</li>
<li>执行函数sysCall_actuation：每个仿真循环都被调用</li>
<li>传感器函数sysCall_sensing：每个仿真循环都被调用</li>
<li>恢复函数sysCall_cleanup：仅在仿真结束被调用一次</li>
</ul>
<h4 id="2-2-2-threaded-child-scripts"><a href="#2-2-2-threaded-child-scripts" class="headerlink" title="2.2.2 threaded child scripts"></a>2.2.2 threaded child scripts</h4><p>threaded child scripts将会启用一个线程，线程的启用和恢复由主脚本的sim.launchThreadedChildScripts和sim.resumeThreads函数控制。当线程子脚本正在执行时，不会二次启动它。<br><strong>Tips</strong>：threaded child scripts存在耗时的问题</p>
<p>threaded child scripts包括两个函数部分：</p>
<ul>
<li>线程主部分函数sysCall_threadmain</li>
<li>恢复函数sysCall_cleanup</li>
</ul>
<p>可以通过以下三个函数控制threaded child scripts的执行: sim.setThreadSwitchTiming、sim.setThreadAutomaticSwitch、sim.switchThread</p>
<h3 id="2-3-Script-simulation-parameters"><a href="#2-3-Script-simulation-parameters" class="headerlink" title="2.3 Script simulation parameters"></a>2.3 Script simulation parameters</h3><p>脚本仿真参数，在脚本中可以通过以下函数读取和设置仿真参数：</p>
<ul>
<li>sim.getScriptSimulationParameter</li>
<li>sim.setScriptSimulationParameter</li>
</ul>
<h3 id="2-4-Customization-scripts"><a href="#2-4-Customization-scripts" class="headerlink" title="2.4 Customization scripts"></a>2.4 <a href="http://www.coppeliarobotics.com/helpFiles/index.html" target="_blank" rel="noopener">Customization scripts</a></h3><p>自定义脚本主要用于对仿真场景的拓展，比如控制仿真地面的大小：<br><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_4.png" alt="pics1_4"></p>
<h3 id="2-5-Callback-functions"><a href="#2-5-Callback-functions" class="headerlink" title="2.5 Callback functions"></a>2.5 Callback functions</h3><p>回调函数包括以下三种；</p>
<ul>
<li>Dynamics callback functions：动态回调函数，通常被non-threaded child script或customization script使用。</li>
<li><a href="http://www.coppeliarobotics.com/helpFiles/index.html" target="_blank" rel="noopener">Joint callback functions</a>：关节回调函数，通常用于编写低级的控制程序（PID控制），每个仿真间隔将被调用10次以上。</li>
<li>The contact callback function：用于物理引擎检测障碍物，满足某个条件时触发contact callback function。</li>
</ul>
<h3 id="2-5-Script-dialog"><a href="#2-5-Script-dialog" class="headerlink" title="2.5 Script dialog"></a>2.5 Script dialog</h3><p>可以通过脚本对话框Script dialog：[Menu bar —&gt; Tools —&gt; Scripts]自行添加脚本文件。</p>
<h3 id="2-6-Script-execution-order"><a href="#2-6-Script-execution-order" class="headerlink" title="2.6 Script execution order"></a>2.6 Script execution order</h3><p>脚本的执行顺序如下：</p>
<ul>
<li>threaded child scripts are launched/resumed (order can be adjusted via sim.setThreadResumeLocation)</li>
<li>non-threaded child scripts are called</li>
<li>customization scripts are called</li>
<li>add-on scripts are called</li>
</ul>
<h2 id="3-遇到的Vrep中Python-Api函数—-gt-属于client端的远程API函数"><a href="#3-遇到的Vrep中Python-Api函数—-gt-属于client端的远程API函数" class="headerlink" title="3.遇到的Vrep中Python Api函数—&gt;属于client端的远程API函数"></a>3.<a href="http://www.coppeliarobotics.com/helpFiles/en/remoteApiFunctionsPython.htm" target="_blank" rel="noopener">遇到的Vrep中Python Api函数</a>—&gt;属于client端的远程API函数</h2><ul>
<li>simxCallScriptFunction: 调用Vrep中Lua脚本中的函数</li>
<li>simxStart：其中timeOutInMs参数为正数时，表示初次连接等待时间，而函数执行的阻塞时间为默认5000ms；当该参数为负数时，正数部分为函数执行的阻塞时间，而初次连接的等待时间为5000ms。</li>
<li>simxStartSimulation：启动仿真。vrep端可以不用提前启动，而通过该函数来启动仿真。</li>
<li>simxGetObjectHandle：获取物体句柄函数，物体名字后需要添加“#”，因为vrep默认的取名风格objectName#x。</li>
</ul>
<h2 id="4-遇到的Vrep中Lua-Api函数—-gt-属于server端的常规API函数，在Regular-API目录下查找API文档"><a href="#4-遇到的Vrep中Lua-Api函数—-gt-属于server端的常规API函数，在Regular-API目录下查找API文档" class="headerlink" title="4.遇到的Vrep中Lua Api函数—&gt;属于server端的常规API函数，在Regular API目录下查找API文档"></a>4.<a href="http://www.coppeliarobotics.com/helpFiles/index.html" target="_blank" rel="noopener">遇到的Vrep中Lua Api函数</a>—&gt;属于server端的常规API函数，在Regular API目录下查找API文档</h2><p><strong>单位使用说明</strong>：所有API的单位都是米、千克、秒和弧度，或者它们的组合(除非另有明确说明)。用户界面的单位是米、千克、秒和度。</p>
<p><strong>一般函数</strong>：</p>
<ul>
<li>sim.getObjectName:获取物体名称，得到的名称带有下标（e.g. “myRobot#42”）</li>
<li>sim.getNameSuffix：从带有下标的物体名称中取出下标和名称前部分</li>
<li>sim.getObjectHandle:获取物体句柄</li>
<li>sim.getJointPosition:获取关节位置</li>
<li>sim.displayDialog:显示消息对话框 </li>
<li>sim.getObjectMatrix：获取物体的位姿矩阵，以table形式返回，表中元素数为12（类似作用的函数有：sim.getObjectOrientation，sim.getObjectPosition）</li>
<li>sim.setObjectMatrix: 设置物体的变换矩阵</li>
<li>sim.getCollectionHandle：根据集合句柄的名称获取集合句柄</li>
<li>sim.getObjectSpecialProperty：获取场景对象的特殊属性,：collidable、measurable.etc</li>
<li>sim.boolOr32：在两个数字之间执行32位布尔或运算</li>
<li>sim.addDrawingObject:添加将在场景中显示的绘图对象</li>
<li>sim.setJointPosition:设置关节的固有位置</li>
<li>sim.addDrawingObjectItem:向之前的绘图对象插入新的属性，绘图主函数</li>
<li>getObjectAssociatedWithScript:获取脚本所对应的对象的句柄</li>
<li>sim.getSimulationState：获取当前的仿真状态</li>
<li>sim.setThreadAutomaticSwitch：是否允许控制线程进行自动切换</li>
<li>sim.switchThread：允许指定当前线程切换到另一个线程的确切时刻</li>
<li>sim.clearStringSignal:清除字符串信号</li>
</ul>
<p><strong>路径规划相关函数</strong>：</p>
<ul>
<li>sim.getIkGroupHandle:获取逆运动学解算IK组的句柄</li>
<li>sim.getConfigForTipPose：随机搜索与给定末端执行器位置/方向匹配的机械手关节配置，若存在则返回一组关节角。通过返回值判断目标位置对应的末端执行器是否存在且是否产生碰撞。</li>
<li>sim.generateIkPath:生成一条直线(即笛卡尔空间中的最短路径)驱动机器人从当前配置到目标配置的路径。</li>
<li>sim.setStringSignal: 设置字符串信号的值</li>
<li>sim.getStringSignal：获取字符串信号的值</li>
<li>sim.packFloatTable：将浮点数表打包成字符串</li>
</ul>
<p><strong>常见的常量</strong>：</p>
<ul>
<li>sim.objectspecialproperty_collidable：物体可碰撞属性</li>
</ul>
<p><strong>OMPL API</strong>:<br><strong>目录</strong>：V-REP API framework—&gt;Other Interfaces—&gt;OMPL Plugin API reference或者More details here.<br>1) 使用OMPL进行运动规划的一般步骤<br>   创建任务—&gt;选定规划算法—&gt;设置状态空间—&gt;设置碰撞对—&gt;设置开始和目标状态—&gt;计算出一条或多条路径—&gt;销毁创建的任务</p>
<p>2) 常见函数</p>
<ul>
<li>simOMPL.createTask:创建任务</li>
<li>simOMPL.setAlgorithm：选定规划算法</li>
<li>simOMPL.createStateSpace：为每个关节创建状态空间</li>
<li>simOMPL.setStateSpace：设置整个任务的状态空间</li>
<li>simOMPL.setCollisionPairs：设置碰撞对</li>
<li>simOMPL.setStartState/simOMPL.setGoalState:设置起始和目标状态</li>
<li>simOMPL.addGoalState:添加目标状态，但不清除以前设置的目标状态(如果有)。</li>
<li>simOMPL.setStateValidityCheckingResolution:设置状态有效性检验的分辨率，表示为状态空间范围的分数</li>
<li>simOMPL.compute：使用OMPL找到此运动规划任务的解决方案。</li>
</ul>
<p>3) <a href="http://ompl.kavrakilab.org/planners.html" target="_blank" rel="noopener">OMPL运动规划库中常见的规划器介绍</a><br>规划器非常多，根据不同的用途和要求进行选择。中文介绍参考网站：<a href="https://zhenshenglee.github.io/2016/09/03/160903-ompl1/" target="_blank" rel="noopener">https://zhenshenglee.github.io/2016/09/03/160903-ompl1/</a></p>
<h2 id="5-Vrep中子脚本线程执行"><a href="#5-Vrep中子脚本线程执行" class="headerlink" title="5.Vrep中子脚本线程执行"></a>5.<a href="http://www.coppeliarobotics.com/helpFiles/index.html" target="_blank" rel="noopener">Vrep中子脚本线程执行</a></h2><p>Vrep中thread script的执行是以协程模拟多线程的方式进行的，即执行多线程过程分为很多个时间片，自动在不同的线程中切换，实现多线程的效果。所以在实际使用thread script时，要合理控制线程切换，使程序执行时间合理。<br>在目录：Writing code in and around V-REP—&gt;Embedded scripts—&gt;Simulation scripts—&gt;The main and child scripts—&gt;Child scripts<br><a href="https://blog.csdn.net/u013528298/article/details/80594751" target="_blank" rel="noopener">参考博客</a>,线程切换控制的常用函数：</p>
<ul>
<li>sim.setThreadAutomaticSwitch()</li>
<li>sim.switchthread()</li>
<li>sim.setThreadSwitchTiming</li>
</ul>
<p>示例代码，路径规划中机械臂响应位置控制指令的thread script：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">-- This threaded script is only used for executing some precalculated motion on this robot</span><br><span class="line">function sysCall_threadmain()</span><br><span class="line">    -- Initialization:</span><br><span class="line">    jh=&#123;-1,-1,-1,-1,-1,-1&#125;</span><br><span class="line">    for i=1,6,1 do</span><br><span class="line">        jh[i]=sim.getObjectHandle(&apos;IRB4600_joint&apos;..i)</span><br><span class="line">    end</span><br><span class="line">    model=sim.getObjectAssociatedWithScript(sim.handle_self)</span><br><span class="line">    modelName=sim.getObjectName(model)</span><br><span class="line"></span><br><span class="line">    -- Main function:</span><br><span class="line">    while sim.getSimulationState()~=sim.simulation_advancing_abouttostop do</span><br><span class="line">        local path=sim.getStringSignal(modelName..&apos;runPath&apos;)</span><br><span class="line">        if path and #path&gt;0 then</span><br><span class="line">            path=sim.unpackFloatTable(path)</span><br><span class="line">            sim.setThreadAutomaticSwitch(false)  --the thread switching is temporarily disabled</span><br><span class="line">            for i=1,#path/6,1 do</span><br><span class="line">                for j=1,6,1 do</span><br><span class="line">                    sim.setJointPosition(jh[j],path[(i-1)*6+j])</span><br><span class="line">                end</span><br><span class="line">                sim.switchThread()</span><br><span class="line">            end</span><br><span class="line">            sim.setThreadAutomaticSwitch(false)</span><br><span class="line">            sim.clearStringSignal(modelName..&apos;runPath&apos;)</span><br><span class="line">        end</span><br><span class="line">        sim.switchThread()</span><br><span class="line">    end</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<h2 id="6-Vrep中路径规划的两种情况"><a href="#6-Vrep中路径规划的两种情况" class="headerlink" title="6.Vrep中路径规划的两种情况"></a>6.Vrep中路径规划的两种情况</h2><p>具体程序参考Vrep的Python程序例程：<code>pathPlanningTest.py</code><br>1) 目标点由笛卡尔空间的位姿点给出，此时的思路是：<br>   位姿点—&gt;逆解算得到配置空间对应的多个关节坐标（<strong>满足一定的精度即可，space metric作为判定条件。然后根据起始点和目标点坐标的配置空间距离进行排序</strong>），并验证关节坐标的无碰撞和可行性—&gt;在配置空间进行路径规划<br>2) 目标点由配置空间的关节坐标直接给出，此时的思路是：<br>   在配置空间直接进行路径规划</p>
<p>路径规划要考虑的四要素：</p>
<ul>
<li>机械臂运动学</li>
<li>关节限位</li>
<li>机械臂防自碰撞</li>
<li>机械臂与障碍物间的防碰撞</li>
</ul>
<p><strong>Tips</strong>:</p>
<ul>
<li>早期Vrep<a href="http://www.coppeliarobotics.com/helpFiles/en/oldMotionPlanningModule.htm" target="_blank" rel="noopener">内建路径规划</a>功能（不建议使用）</li>
</ul>
<h2 id="7-关于Vrep自带模型的D-H参数获取的办法"><a href="#7-关于Vrep自带模型的D-H参数获取的办法" class="headerlink" title="7.关于Vrep自带模型的D-H参数获取的办法"></a>7.关于Vrep自带模型的D-H参数获取的办法</h2><p>1) 使用vrep在tool目录下提供的D-H参数提取工具<code>DH_extractor</code>进行获取<br>2) 根据机械臂的名称去官网下载其CAD模型，利用CAD软件进行获取</p>
<h2 id="8-远程API-工作方式分析-官方文档"><a href="#8-远程API-工作方式分析-官方文档" class="headerlink" title="8.远程API)工作方式分析(官方文档)"></a>8.<a href="(https://blog.csdn.net/DanielDingshengli/article/details/86492344">远程API</a>)工作方式分析(<a href="http://www.coppeliarobotics.com/helpFiles/en/remoteApiModusOperandi.htm" target="_blank" rel="noopener">官方文档</a>)</h2><p>API函数操作模式：</p>
<ul>
<li>simx_opmode_oneshot</li>
<li>simx_opmode_oneshot_wait</li>
<li>simx_opmode_streaming</li>
<li>simx_opmode_oneshot_split</li>
<li>simx_opmode_discontinue</li>
<li>simx_opmode_buffer</li>
<li>simx_opmode_remove</li>
</ul>
<p>1) 阻塞式和非阻塞式<br>一个重要例子：通过远程API控制多个关节同时转动，可以通过先暂停通信线程，发送完指令后再恢复通信线程实现。暂停通信线程时，远程客户端不会与远程服务器之间进行通信。示例代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 控制命令需要同时方式，故暂停通信，用于存储所有控制命令一起发送</span><br><span class="line">vrep.simxPauseCommunication(clientID, True)</span><br><span class="line">for i in range(jointNum):</span><br><span class="line">   vrep.simxSetJointTargetPosition(clientID, jointHandle[i], 120/RAD2DEG, vrep.simx_opmode_oneshot)</span><br><span class="line">vrep.simxPauseCommunication(clientID, False)</span><br></pre></td></tr></table></figure></p>
<p>2) 数据流的形式<br>   实现的效果是定时从某个句柄中获取需要的数据，通过<code>simx_opmode_streaming</code>和<code>simx_opmode_buffer</code>实现，示例代码：<br>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// Streaming operation request (subscription) (function returns immediately (non-blocking)):</span><br><span class="line">simxGetJointPosition(clientID,jointHandle,&amp;jointPosition,simx_opmode_streaming);</span><br><span class="line">// The control loop:</span><br><span class="line"> while (simxGetConnectionId(clientID)!=-1) // while we are connected to the server..</span><br><span class="line">&#123; </span><br><span class="line">    // Fetch the newest joint value from the inbox (func. returns immediately (non-blocking):</span><br><span class="line">    if (simxGetJointPosition(clientID,jointHandle,&amp;jointPosition,simx_opmode_buffer==simx_return_ok) </span><br><span class="line">    &#123; </span><br><span class="line">        // here we have the newest joint position in variable jointPosition!    </span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        // once you have enabled data streaming, it will take a few ms until the first value has arrived. So if</span><br><span class="line">        // we landed in this code section, this does not always mean we have an error!!!</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Streaming operation is enabled/disabled individually for each command and</span><br><span class="line">// object(s) the command applies to. In above case, only the joint position of</span><br><span class="line">// the joint with handle jointHandle will be streamed.</span><br></pre></td></tr></table></figure></p>
<p>3) 同步操作<br>   。。。</p>
<h2 id="9-Vrep中关节不同的属性"><a href="#9-Vrep中关节不同的属性" class="headerlink" title="9.Vrep中关节不同的属性"></a>9.<a href="http://www.coppeliarobotics.com/helpFiles/index.html" target="_blank" rel="noopener">Vrep中关节不同的属性</a></h2><p>参考文档：Entities—&gt;Scene objects—&gt;Joint—&gt;Joint types and operation<br>不同的关节属性对应不同要的仿真要求，比如位置控制、动力学仿真、关节力矩控制等。</p>
<p><a href="https://blog.csdn.net/u013528298/article/details/80974872" target="_blank" rel="noopener">根据关节的属性</a>使用不同函数设置关节的位置、速度：</p>
<ul>
<li>simSetJointPosition() (when your joint is not in force/torque mode 比如说inverse kinema模式)</li>
<li>simSetJointTargetPosition()  (when your joint is in force/torque mode, its motor enabled and its control loop also enabled)</li>
<li>simSetJointTargetVelocity (when your joint is in force/torque mode, its motor enabled, and its control loop NOT enabled)</li>
</ul>
<h2 id="10-Vrep中仿真过程不同状态的介绍"><a href="#10-Vrep中仿真过程不同状态的介绍" class="headerlink" title="10.Vrep中仿真过程不同状态的介绍"></a>10.Vrep中仿真过程不同状态的介绍</h2><p>仿真状态分为：停止、开始、暂停三个状态。在仿真内部还有一些内部状态用来表示下一时刻的状态，使程序更好地控制仿真过程，状态切换图如下：<br><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_9.png" alt="pics1_9"><br>获取状态的函数为：<code>sim.getSimulationState</code>，返回的状态即为上图中的状态。</p>
<h2 id="11-参考网站"><a href="#11-参考网站" class="headerlink" title="11.参考网站"></a>11.参考网站</h2><ul>
<li><a href="https://blog.csdn.net/u013528298/article/category/7519401" target="_blank" rel="noopener">https://blog.csdn.net/u013528298/article/category/7519401</a></li>
</ul>
<h1 id="二、V-rep进阶知识点"><a href="#二、V-rep进阶知识点" class="headerlink" title="二、V-rep进阶知识点"></a>二、V-rep进阶知识点</h1><h2 id="1-vrep使用b0RemoteApi工作模式"><a href="#1-vrep使用b0RemoteApi工作模式" class="headerlink" title="1. vrep使用b0RemoteApi工作模式"></a>1. vrep使用<code>b0RemoteApi</code>工作模式</h2><p>与之前版本的Remote API相比，新版本的Vrep推荐<code>b0RemoteApi</code>，官方说这种方式更灵活好用。</p>
<p>运行<code>C:\Program Files\V-REP3\V-REP_PRO_EDU\programming\b0RemoteApiBindings\python</code>目录下的<code>simpleTest.py</code>程序，遇到如下错误：</p>
<blockquote>
<p>OSError: [WinError 193] %1 不是有效的 Win32 应用程序。</p>
</blockquote>
<p><strong>解决过程</strong>：</p>
<ul>
<li>开始参考如下网站使用anaconda重建一个32位的python环境：<br><a href="https://blog.csdn.net/vample/article/details/88877745" target="_blank" rel="noopener">https://blog.csdn.net/vample/article/details/88877745</a> ，最终发现并不是这个原因导致的，因为提供的DLL文件都是64位的，所以不是因为python版本不匹配的原因报错；</li>
<li>最终google之后发现解决办法：<a href="https://stackoverflow.com/questions/19849077/error-loading-dll-in-python-not-a-valid-win32-application" target="_blank" rel="noopener">https://stackoverflow.com/questions/19849077/error-loading-dll-in-python-not-a-valid-win32-application</a><br>是因为之前添加的DLL不够全，将<code>C:\Program Files\V-REP3\V-REP_PRO_EDU</code>目录下所有DLL文件添加至<code>\programming\b0RemoteApiBindings\python</code>目录下，然后即可正常<code>simpleTest.py</code>程序。</li>
</ul>
<p>常用conda命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 设置32位set CONDA_FORCE_32BIT=1</span><br><span class="line"># 切回系统默认set CONDA_FORCE_32BIT=</span><br><span class="line"># 查看当前环境详细信息 conda info</span><br><span class="line"># 查看当前环境信息 conda info --envs</span><br><span class="line"># 切换环境 conda activate env_name，conda deactivate env_name</span><br><span class="line"># 移除环境 conda remove -n env_name --all</span><br><span class="line"># 安装包：activate env_name，conda install pandas</span><br></pre></td></tr></table></figure></p>
<h3 id="1-0-Vrep-b0RemoteApi工作模式解析"><a href="#1-0-Vrep-b0RemoteApi工作模式解析" class="headerlink" title="1.0 Vrep b0RemoteApi工作模式解析"></a>1.0 Vrep <a href="http://www.coppeliarobotics.com/helpFiles/en/b0RemoteApi-python.htm" target="_blank" rel="noopener">b0RemoteApi</a>工作模式解析</h3><p>类似ROS中的松耦合通讯机制。<br>与vrep regular API相比，B0-based remote API函数需要一个额外的参数：用于执行函数调用的话题（Topic）或者通讯频道（communication channel）参数。Topic可以从以下5个函数的返回值获取：</p>
<ul>
<li>simxServiceCall: 用于阻塞模式，即client发送命令到server端执行后，等待server返回一个响应给client。通常用于只需要server端执行一次的命令，比如<code>simxGetObjectHandle</code></li>
<li>simxDefaultPublisher: 用于非阻塞模式，client端向server端发送命令后不等待server端的回应。比如<code>simxSetJointPosition</code></li>
<li>simxDefaultSubscriber: 该方式让server端持续执行某函数，并且将函数的响应结果持续返回至client端，client端在回调函数中收到返回的数据流。通常用于需要在server端持续执行的命令，比如<code>simxGetJointForce</code>。此外，传入的回调函数将通过执行<code>simxSpinOnce</code>函数进行调用。</li>
<li>simxCreatePublisher: 与<code>simxDefaultPublisher</code>类似，不同的是创建一个专用的publisher Topic，即创建一个专用的发布数据的频道。主要用于特定的命令或者函数，比如数据量大的函数<code>simxSetVisionSensorImage</code>。</li>
<li>simxCreateSubscriber: 与<code>simxDefaultSubscriber</code>类似，不同的是创建一个专用的subscriber Topic，即创建一个专用的订阅数据的频道。主要用于特定的命令或者函数，比如数据量大的函数<code>simxGetVisionSensorImage</code>。</li>
</ul>
<p>原文如下：<br><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_7.png" alt="pics1_7"></p>
<p>默认情况下，B0-based remote API的Client和Server之间是异步工作的。可以通过设置使Client单独触发每个仿真时间片，达到同步工作模式。以下是Python形式Client端同步工作模式的示例代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">import b0RemoteApi</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">with b0RemoteApi.RemoteApiClient(&apos;b0RemoteApi_pythonClient&apos;,&apos;b0RemoteApi&apos;) as client:    </span><br><span class="line">    doNextStep=True</span><br><span class="line"></span><br><span class="line">    def simulationStepStarted(msg):</span><br><span class="line">        simTime=msg[1][b&apos;simulationTime&apos;];</span><br><span class="line">        print(&apos;Simulation step started. Simulation time: &apos;,simTime)</span><br><span class="line">        </span><br><span class="line">    def simulationStepDone(msg):</span><br><span class="line">        simTime=msg[1][b&apos;simulationTime&apos;];</span><br><span class="line">        print(&apos;Simulation step done. Simulation time: &apos;,simTime);</span><br><span class="line">        global doNextStep</span><br><span class="line">        doNextStep=True</span><br><span class="line">        </span><br><span class="line">    client.simxSynchronous(True)</span><br><span class="line">    client.simxGetSimulationStepStarted(client.simxDefaultSubscriber(simulationStepStarted));</span><br><span class="line">    client.simxGetSimulationStepDone(client.simxDefaultSubscriber(simulationStepDone));</span><br><span class="line">    client.simxStartSimulation(client.simxDefaultPublisher())</span><br><span class="line">    </span><br><span class="line">    startTime=time.time()</span><br><span class="line">    while time.time()&lt;startTime+5: </span><br><span class="line">        if doNextStep:</span><br><span class="line">            doNextStep=False</span><br><span class="line">            client.simxSynchronousTrigger()</span><br><span class="line">        client.simxSpinOnce()</span><br><span class="line">    client.simxStopSimulation(client.simxDefaultPublisher())</span><br></pre></td></tr></table></figure></p>
<p>在Server端添加b0RemoteApiServer，参考<a href="http://www.coppeliarobotics.com/helpFiles/index.html" target="_blank" rel="noopener">官方文档</a>：Writing code in and around V-REP—&gt;V-REP API framework—&gt;Remote API—&gt;BØ-based remote API—&gt;Enabling the B0-based remote API - server side<br>直接通过File—&gt;Load Model将<code>Models/tools/B0 remote Api server.ttm</code>添加至当前场景即可。<br><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_8.png" alt="pics1_8"></p>
<h3 id="1-1-vrep-b0RemoteApi工作模式下API之间的关系："><a href="#1-1-vrep-b0RemoteApi工作模式下API之间的关系：" class="headerlink" title="1.1 vrep b0RemoteApi工作模式下API之间的关系："></a>1.1 vrep <code>b0RemoteApi</code>工作模式下API之间的关系：</h3><ul>
<li><a href="http://www.coppeliarobotics.com/helpFiles/en/b0RemoteApi-python.htm" target="_blank" rel="noopener">Client端</a>：使用B0-based remote API：<code>b0RemoteApi.py</code>，实现方式是直接将server端b0 API中的函数名进行再次封装，然后发送至server端。</li>
<li>Server端：使用server端b0 API，API文件为<code>C:\Program Files\V-REP3\V-REP_PRO_EDU\lua\b0RemoteApiServer.lua</code>，server端b0 API文件b0RemoteApiServer.lua内部实现主要是将regular API进行封装。</li>
</ul>
<h2 id="2-vrep中吸盘工具suction-pad的使用"><a href="#2-vrep中吸盘工具suction-pad的使用" class="headerlink" title="2. vrep中吸盘工具suction pad的使用"></a>2. vrep中吸盘工具suction pad的使用</h2><p>参考以下资料：</p>
<ul>
<li>场景<code>C:\Program Files\V-REP3\V-REP_PRO_EDU\scenes\reflexxesMotionLibraryType2Demo.ttt</code>中有吸盘工具的使用</li>
<li>模型<code>C:\Program Files\V-REP3\V-REP_PRO_EDU\models\robots\non-mobile\MTB robot.ttm</code>中有吸盘工具的使用</li>
<li><a href="http://www.forum.coppeliarobotics.com/viewtopic.php?f=9&amp;t=5317&amp;p=21341&amp;hilit=vrep+suction+pad#p21341" target="_blank" rel="noopener">http://www.forum.coppeliarobotics.com/viewtopic.php?f=9&amp;t=5317&amp;p=21341&amp;hilit=vrep+suction+pad#p21341</a></li>
</ul>
<p>添加吸盘工具至机械臂末端，根据吸盘的子程序：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">function sysCall_init() </span><br><span class="line">    s=sim.getObjectHandle(&apos;suctionPadSensor&apos;)</span><br><span class="line">    l=sim.getObjectHandle(&apos;suctionPadLoopClosureDummy1&apos;)</span><br><span class="line">    l2=sim.getObjectHandle(&apos;suctionPadLoopClosureDummy2&apos;)</span><br><span class="line">    b=sim.getObjectHandle(&apos;suctionPad&apos;)</span><br><span class="line">    suctionPadLink=sim.getObjectHandle(&apos;suctionPadLink&apos;)</span><br><span class="line"></span><br><span class="line">    infiniteStrength=sim.getScriptSimulationParameter(sim.handle_self,&apos;infiniteStrength&apos;)</span><br><span class="line">    maxPullForce=sim.getScriptSimulationParameter(sim.handle_self,&apos;maxPullForce&apos;)</span><br><span class="line">    maxShearForce=sim.getScriptSimulationParameter(sim.handle_self,&apos;maxShearForce&apos;)</span><br><span class="line">    maxPeelTorque=sim.getScriptSimulationParameter(sim.handle_self,&apos;maxPeelTorque&apos;)</span><br><span class="line"></span><br><span class="line">    sim.setLinkDummy(l,-1)</span><br><span class="line">    sim.setObjectParent(l,b,true)</span><br><span class="line">    m=sim.getObjectMatrix(l2,-1)</span><br><span class="line">    sim.setObjectMatrix(l,-1,m)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">function sysCall_cleanup() </span><br><span class="line">    sim.setLinkDummy(l,-1)</span><br><span class="line">    sim.setObjectParent(l,b,true)</span><br><span class="line">    m=sim.getObjectMatrix(l2,-1)</span><br><span class="line">    sim.setObjectMatrix(l,-1,m)</span><br><span class="line">end </span><br><span class="line"></span><br><span class="line">function sysCall_sensing() </span><br><span class="line">    parent=sim.getObjectParent(l)</span><br><span class="line">    if (sim.getScriptSimulationParameter(sim.handle_self,&apos;active&apos;)==false) then</span><br><span class="line">        if (parent~=b) then</span><br><span class="line">            sim.setLinkDummy(l,-1)</span><br><span class="line">            sim.setObjectParent(l,b,true)</span><br><span class="line">            m=sim.getObjectMatrix(l2,-1)</span><br><span class="line">            sim.setObjectMatrix(l,-1,m)</span><br><span class="line">        end</span><br><span class="line">    else</span><br><span class="line">        if (parent==b) then</span><br><span class="line">            -- Here we want to detect a respondable shape, and then connect to it with a force sensor (via a loop closure dummy dummy link)</span><br><span class="line">            -- However most respondable shapes are set to &quot;non-detectable&quot;, so &quot;sim.readProximitySensor&quot; or similar will not work.</span><br><span class="line">            -- But &quot;sim.checkProximitySensor&quot; or similar will work (they don&apos;t check the &quot;detectable&quot; flags), but we have to go through all shape objects!</span><br><span class="line">            index=0</span><br><span class="line">            while true do</span><br><span class="line">                shape=sim.getObjects(index,sim.object_shape_type)</span><br><span class="line">                if (shape==-1) then</span><br><span class="line">                    break</span><br><span class="line">                end</span><br><span class="line">                if (shape~=b) and (sim.getObjectInt32Parameter(shape,sim.shapeintparam_respondable)~=0) and (sim.checkProximitySensor(s,shape)==1) then</span><br><span class="line">                    -- Ok, we found a respondable shape that was detected</span><br><span class="line">                    -- We connect to that shape:</span><br><span class="line">                    -- Make sure the two dummies are initially coincident:</span><br><span class="line">                    sim.setObjectParent(l,b,true)</span><br><span class="line">                    m=sim.getObjectMatrix(l2,-1)</span><br><span class="line">                    sim.setObjectMatrix(l,-1,m)</span><br><span class="line">                    -- Do the connection:</span><br><span class="line">                    sim.setObjectParent(l,shape,true)</span><br><span class="line">                    sim.setLinkDummy(l,l2)</span><br><span class="line">                    break</span><br><span class="line">                end</span><br><span class="line">                index=index+1</span><br><span class="line">            end</span><br><span class="line">        else</span><br><span class="line">            -- Here we have an object attached</span><br><span class="line">            if (infiniteStrength==false) then</span><br><span class="line">                -- We might have to conditionally beak it apart!</span><br><span class="line">                result,force,torque=sim.readForceSensor(suctionPadLink) -- Here we read the median value out of 5 values (check the force sensor prop. dialog)</span><br><span class="line">                if (result&gt;0) then</span><br><span class="line">                    breakIt=false</span><br><span class="line">                    if (force[3]&gt;maxPullForce) then breakIt=true end</span><br><span class="line">                    sf=math.sqrt(force[1]*force[1]+force[2]*force[2])</span><br><span class="line">                    if (sf&gt;maxShearForce) then breakIt=true end</span><br><span class="line">                    if (torque[1]&gt;maxPeelTorque) then breakIt=true end</span><br><span class="line">                    if (torque[2]&gt;maxPeelTorque) then breakIt=true end</span><br><span class="line">                    if (breakIt) then</span><br><span class="line">                        -- We break the link:</span><br><span class="line">                        sim.setLinkDummy(l,-1)</span><br><span class="line">                        sim.setObjectParent(l,b,true)</span><br><span class="line">                        m=sim.getObjectMatrix(l2,-1)</span><br><span class="line">                        sim.setObjectMatrix(l,-1,m)</span><br><span class="line">                    end</span><br><span class="line">                end</span><br><span class="line">            end</span><br><span class="line">        end</span><br><span class="line">    end</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>可以发现吸盘子程序已经很完善，会根据吸盘末端和物体之间的距离来判断是否吸取物体，同时吸盘子程序设置了以下参数：<code>active</code>,<code>infiniteStrength</code>,<code>maxPullForce</code>,<code>maxShearForce</code>,<code>maxPeelTorque</code>，前两个分别表示吸盘是否激活、吸盘吸力是否无穷大，默认吸盘激活且吸力无穷大，参数可以通过吸盘子程序的参数服务器修改：<br><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_10.png" alt="pics1_10"><br>我们需要控制的就是移动机械臂，使末端接近被吸物体，然后吸盘就会自动吸取物体。需要将被吸物体释放时，需要修改吸盘子程序并添加自定义程序，一种思路是根据某个条件设置<code>active</code>参数为false，然后释放被吸物体即可，参考模型<code>C:\Program Files\V-REP3\V-REP_PRO_EDU\models\robots\non-mobile\MTB robot.ttm</code>中吸盘工具的使用。</p>
<h2 id="3-vrep中力-力矩传感器（force-sensor）的使用"><a href="#3-vrep中力-力矩传感器（force-sensor）的使用" class="headerlink" title="3. vrep中力/力矩传感器（force sensor）的使用"></a>3. vrep中力/力矩传感器（force sensor）的使用</h2><p>添加force sensor：add-&gt;force sensor，然后使用力传感器刚性地连接两个物体后就可以测量力和力矩。<br>具体过程：以<code>C:\Program Files\V-REP3\V-REP_PRO_EDU\models\robots\non-mobile\MTB robot.ttm</code>为例。通过<code>File-&gt;Load Model</code>载入<code>MTB robot.ttm</code>，可以看到机械臂末端连接了吸盘：<br><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_5.png" alt="pics1_5"><br>接下来的目标是：在机械臂末端和吸盘之间添加力传感器，测量被吸物体对机械臂末端施加的重力，步骤如下：</p>
<ul>
<li>通过<code>add-&gt;force sensor</code>添加force sensor</li>
<li>使用Assemble/Disassemble工具断开MTB_link3Respondable和suctionPad的连接</li>
<li>调整Force_sensor的位置到MTB_link3Respondable和suctionPad之间</li>
<li>使用Assemble/Disassemble工具连接MTB_link3Respondable和Force_sensor</li>
<li>使用Assemble/Disassemble工具连接Force_sensor和suctionPadBodyRespondable。因为Force_sensor连接两个刚性物体，所以要将Force_sensor和suctionPadBodyRespondable相连，而不是和suctionPad相连。<br>完成以上步骤后的模型关系图为：<br><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_6.png" alt="pics1_6"><br>之后再参考<a href="https://blog.csdn.net/weixin_34375054/article/details/85882691" target="_blank" rel="noopener">博客</a>添加一个Graph，并将Force_sensor的Z轴方向的力作为显示数据添加至Graph，运行MTB robot.ttm就可以看到物体的重力。</li>
</ul>
<p><strong>Tips：</strong> 吸盘工具自带了力传感器，<code>suctionPad</code>就是一个力传感器。</p>
<p>参考资料：</p>
<ul>
<li>官方文档：Entities-&gt;Scene objects-&gt;Force sensors </li>
<li>测量值不稳定的解决：<a href="http://www.forum.coppeliarobotics.com/viewtopic.php?f=9&amp;t=6614" target="_blank" rel="noopener">http://www.forum.coppeliarobotics.com/viewtopic.php?f=9&amp;t=6614</a></li>
<li>相关博客：<a href="https://blog.csdn.net/weixin_34375054/article/details/85882691" target="_blank" rel="noopener">https://blog.csdn.net/weixin_34375054/article/details/85882691</a></li>
</ul>
<h2 id="4-Vrep中不同物理仿真引擎的使用"><a href="#4-Vrep中不同物理仿真引擎的使用" class="headerlink" title="4. Vrep中不同物理仿真引擎的使用"></a>4. Vrep中不同物理仿真引擎的使用</h2><p>Bullet和ODE主要用于游戏中，而Vortex专注于科学物理仿真，计算准确度以及稳定性肯定会比游戏物理引擎要好。所以VREP提供了4个物理引擎还是有道理的，要根据它们的长处来选择合适的引擎进行仿真，不能总是用默认的Bullet。</p>
<p><font color="#ff99ff" size="3" face="黑体"><a href="https://www.zhihu.com/question/23309094" target="_blank" rel="noopener">经验分享:</a></font> 关于物理引擎 “Bullet, ODE, 和 Newton” （Vortex 自动忽略）使用经验，对于复杂系统（32个自由度），如果涉及到 V-rep 和 MATLAB, Python, 或 ROS 某一个或者某几个之间的通讯问题，ODE 最佳，Bullet 可用，Newton 不推荐。<br>不涉及通讯，直接 LUA，ODE 依然最佳，Newton 相差无几，甚至会比 ODE 更稳定，Bullet 也可用。</p>
<p><a href="https://blog.csdn.net/menshu1892/article/details/79288143" target="_blank" rel="noopener">V-REP与Vortex Studio的安装</a>，需要申请License，暂且没有操作做成功。</p>
<h2 id="5-使用Vrep控制实物机器人的思路"><a href="#5-使用Vrep控制实物机器人的思路" class="headerlink" title="5. 使用Vrep控制实物机器人的思路"></a>5. 使用Vrep控制实物机器人的思路</h2><p><a href="http://www.forum.coppeliarobotics.com/viewtopic.php?t=5780" target="_blank" rel="noopener">http://www.forum.coppeliarobotics.com/viewtopic.php?t=5780</a></p>
<h2 id="6-使用Reflexxes-Motion-Library（在线运动轨迹生成库）进行轨迹规划"><a href="#6-使用Reflexxes-Motion-Library（在线运动轨迹生成库）进行轨迹规划" class="headerlink" title="6. 使用Reflexxes Motion Library（在线运动轨迹生成库）进行轨迹规划"></a>6. 使用<a href="http://www.reflexxes.ws/" target="_blank" rel="noopener">Reflexxes Motion Library</a>（在线运动轨迹生成库）进行轨迹规划</h2><p>Reflexxes Motion Library是在线运动轨迹生成库，在其官网有关于<a href="http://www.reflexxes.ws/products/reflexxes-motion-libraries.html" target="_blank" rel="noopener">功能</a>方面详细的介绍。在完成实时轨迹规划时，算法的输入输出如下图：<br><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_12.png" alt="pics1_12"><br>基于位置的在线轨迹规划详细输入输出如下图：<br><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_13.png" alt="pics1_13"></p>
<ul>
<li>输入：当前的运动状态（位置、姿态、速度、加速度）、目标运动状态、运动约束（最大速度、最大加速度、最大加加速度）</li>
<li>输出：新的运动状态和轨迹（位姿、速度、加速度）<br>更多的Reflexxes Motion Library轨迹规划知识参考<a href="http://www.reflexxes.ws/software/typeiirml/v1.2.6/docs/page__reflexxes_motion_libraries.html" target="_blank" rel="noopener">官方文档</a>，官方文档详细介绍了Reflexxes Motion Library各<a href="http://www.reflexxes.ws/software/typeiirml/v1.2.6/docs/page__synchronization_behavior.html" target="_blank" rel="noopener">轴同步行为</a>(不同步、时间同步、相位同步)、<a href="http://www.reflexxes.ws/software/typeiirml/v1.2.6/docs/page__source_code.html" target="_blank" rel="noopener">API结构介绍</a>(应用接口层、算法层、数学计算层)等方面的实现。</li>
</ul>
<p>Vrep集成了Reflexxes Motion Library，具体API在<code>Regular API function--&gt;Reflexxes Motion Library type II or IV</code>:<br><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_11.png" alt="pics1_11"><br>在空白场景中拖入UR5型机械臂，打开机械臂对应的子脚本程序，可以看到Reflexxes Motion Library API的使用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">-- This is a threaded script, and is just an example!</span><br><span class="line"></span><br><span class="line">function sysCall_threadmain()</span><br><span class="line">    jointHandles=&#123;-1,-1,-1,-1,-1,-1&#125;</span><br><span class="line">    for i=1,6,1 do</span><br><span class="line">        jointHandles[i]=sim.getObjectHandle(&apos;UR5_joint&apos;..i)</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    -- Set-up some of the RML vectors:</span><br><span class="line">    vel=180</span><br><span class="line">    accel=40</span><br><span class="line">    jerk=80</span><br><span class="line">    currentVel=&#123;0,0,0,0,0,0,0&#125;</span><br><span class="line">    currentAccel=&#123;0,0,0,0,0,0,0&#125;</span><br><span class="line">    maxVel=&#123;vel*math.pi/180,vel*math.pi/180,vel*math.pi/180,vel*math.pi/180,vel*math.pi/180,vel*math.pi/180&#125;</span><br><span class="line">    maxAccel=&#123;accel*math.pi/180,accel*math.pi/180,accel*math.pi/180,accel*math.pi/180,accel*math.pi/180,accel*math.pi/180&#125;</span><br><span class="line">    maxJerk=&#123;jerk*math.pi/180,jerk*math.pi/180,jerk*math.pi/180,jerk*math.pi/180,jerk*math.pi/180,jerk*math.pi/180&#125;</span><br><span class="line">    targetVel=&#123;0,0,0,0,0,0&#125;</span><br><span class="line"></span><br><span class="line">    targetPos1=&#123;90*math.pi/180,90*math.pi/180,-90*math.pi/180,90*math.pi/180,90*math.pi/180,90*math.pi/180&#125;</span><br><span class="line">    sim.rmlMoveToJointPositions(jointHandles,-1,currentVel,currentAccel,maxVel,maxAccel,maxJerk,targetPos1,targetVel)</span><br><span class="line">    sim.wait(2)</span><br><span class="line">    targetPos2=&#123;-90*math.pi/180,45*math.pi/180,90*math.pi/180,135*math.pi/180,90*math.pi/180,90*math.pi/180&#125;</span><br><span class="line">    sim.rmlMoveToJointPositions(jointHandles,-1,currentVel,currentAccel,maxVel,maxAccel,maxJerk,targetPos2,targetVel)</span><br><span class="line"></span><br><span class="line">    targetPos3=&#123;0,0,0,0,0,0&#125;</span><br><span class="line">    sim.rmlMoveToJointPositions(jointHandles,-1,currentVel,currentAccel,maxVel,maxAccel,maxJerk,targetPos3,targetVel)</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>sim.rmlMoveToJointPositions()和sim.rmlMoveToPosition()分别在关节空间和迪卡文空间进行轨迹规划，这两个函数均为阻塞型函数。<strong>使用sim.rmlMoveToPosition()并配合逆运动学可以实现机器人的路径控制，</strong>具体操作可以参考该<a href="https://www.cnblogs.com/21207-iHome/p/6901430.html" target="_blank" rel="noopener">博客内容</a>。</p>
<p>参考资料：</p>
<ul>
<li>Reflexxes Motion Library的使用：<a href="https://www.cnblogs.com/21207-iHome/p/6344467.html" target="_blank" rel="noopener">https://www.cnblogs.com/21207-iHome/p/6344467.html</a></li>
<li>Reflexxes Motion Library API结构介绍：<a href="https://www.cnblogs.com/21207-iHome/p/7724694.html" target="_blank" rel="noopener">https://www.cnblogs.com/21207-iHome/p/7724694.html</a></li>
<li>Reflexxes Motion Library官方API结构介绍：<a href="http://www.reflexxes.ws/software/typeiirml/v1.2.6/docs/page__source_code.html" target="_blank" rel="noopener">http://www.reflexxes.ws/software/typeiirml/v1.2.6/docs/page__source_code.html</a></li>
</ul>
<h2 id="7-vrep不同类型的刚体表示，作用不同"><a href="#7-vrep不同类型的刚体表示，作用不同" class="headerlink" title="7.vrep不同类型的刚体表示，作用不同"></a>7.vrep不同类型的刚体表示，作用不同</h2><p><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_14.png" alt="pics1_14"></p>
<ul>
<li>Simple random shape和Compound random shape主要用来显示</li>
<li>Simple convex shape和Compound convex shape主要用来仿真计算</li>
</ul>
<h1 id="三、V-rep在机械臂仿真中遇到的一些问题"><a href="#三、V-rep在机械臂仿真中遇到的一些问题" class="headerlink" title="三、V-rep在机械臂仿真中遇到的一些问题"></a>三、V-rep在机械臂仿真中遇到的一些问题</h1><h2 id="1-vrep机械臂散架问题"><a href="#1-vrep机械臂散架问题" class="headerlink" title="1.vrep机械臂散架问题"></a>1.vrep机械臂散架问题</h2><p>添加kuka LBR4p机械臂，所有关节原始工作模式是Torque or force mode，将所有关节改为Inverse kinematics mode后运行仿真会出现机械臂散架的问题，这个时候问题解决。<br><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_15.png" alt="pics1_15"><br>在<a href="http://www.coppeliarobotics.com/helpFiles/en/designingDynamicSimulations.htm" target="_blank" rel="noopener">动力学仿真设计</a>章节有讲，上述问题的主要原因是机械臂各个关节设置为动态模式后，关节必须处于Torque or force mode或者hybrid fashion，否则就会由于重力直接跌落，导致机械臂散架。<img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_16.png" alt="pics1_16"><br>所以此时机械臂处于Inverse kinematics mode+Torque or force mode的模式，即使配置好ik target-tip，因为关节之间存在力矩，所以在移动target时机械臂无法完成逆解运动。</p>
<h2 id="2-Vrep逆运动学解算，使用sim-getConfigForTipPose函数输出结果为nil的问题"><a href="#2-Vrep逆运动学解算，使用sim-getConfigForTipPose函数输出结果为nil的问题" class="headerlink" title="2.Vrep逆运动学解算，使用sim.getConfigForTipPose函数输出结果为nil的问题"></a>2.Vrep逆运动学解算，使用sim.getConfigForTipPose函数输出结果为nil的问题</h2><ul>
<li>问题描述：<br><a href="http://www.coppeliarobotics.com/helpFiles/en/apiFunctions.htm" target="_blank" rel="noopener"><code>sim.getConfigForTipPose</code>函数的功能</a>是：给定逆运动学解算器、关节句柄、碰撞对等参数，可以根据ik_target在笛卡尔空间的位姿逆解算出关节空间的坐标，运行一次得到一个关节坐标或nil(如果逆解不存在)。使用<code>sim.getConfigForTipPose</code>得到目标点多个对应的关节坐标，为下一步使用OMPL进行路径规划奠定基础。<br><strong>当前遇到的问题是:</strong> <code>sim.getConfigForTipPose</code>函数一直输出nil值，没有得到有效的关节坐标。</li>
<li><p>场景如下：<br><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_17.png" alt="pics1_17"><br>将kuka LBR4p机械臂安装在Onmirob移动底盘上。对应的逆解对<code>LBR4p_ik_target</code>和<code>LBR4p_ik_tip</code>，以及逆解算组已经设置好，重写LBR4p原始脚本，进行<code>sim.getConfigForTipPose</code>的测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">-- This is a threaded script, and is just an example!</span><br><span class="line"></span><br><span class="line">ikTest=function()</span><br><span class="line">-- Initialization phase:</span><br><span class="line">    jh=&#123;-1,-1,-1,-1,-1,-1,-1&#125;</span><br><span class="line">    for i=1,7,1 do</span><br><span class="line">        jh[i]=sim.getObjectHandle(&apos;LBR4p_joint&apos;..i)</span><br><span class="line">    end</span><br><span class="line">    ikGroup=sim.getIkGroupHandle(&apos;LBR4p&apos;)</span><br><span class="line">    ikTarget=sim.getObjectHandle(&apos;LBR4p_ik_target&apos;)</span><br><span class="line">    collisionPairs=&#123;sim.getCollectionHandle(&apos;LBR4PP&apos;),sim.getCollectionHandle(&apos;not_LBR4PP&apos;)&#125;</span><br><span class="line">    target1=sim.getObjectHandle(&apos;testTarget3&apos;)</span><br><span class="line">    --approachDirectionObstacle=sim.getObjectHandle(&apos;approachDirectionObstacle&apos;)</span><br><span class="line">    metric=&#123;0.5,1,1,0.5,0.1,0.2,0.1&#125;</span><br><span class="line">    forbidLevel=0</span><br><span class="line">    ikShift=0.1</span><br><span class="line">    ikSteps=50</span><br><span class="line"></span><br><span class="line">--------------------------</span><br><span class="line">------for ik test---------</span><br><span class="line">    local m=sim.getObjectMatrix(target1,-1)</span><br><span class="line">    sim.setObjectMatrix(ikTarget,-1,m)</span><br><span class="line">    local c=sim.getConfigForTipPose(ikGroup,jh,0.65,10,nil,collisionPairs)</span><br><span class="line">    print(c)</span><br><span class="line">    while true do</span><br><span class="line">        local m=sim.getObjectMatrix(target1,-1)</span><br><span class="line">        sim.setObjectMatrix(ikTarget,-1,m)</span><br><span class="line">        local c=sim.getConfigForTipPose(ikGroup,jh,0.65,10,nil,collisionPairs)</span><br><span class="line">        print(c)</span><br><span class="line">        if c then</span><br><span class="line">            local gc = c</span><br><span class="line">            sim.rmlMoveToJointPositions(jointHandles,-1,currentVel,currentAccel,maxVel,maxAccel,maxJerk,gc,targetVel)</span><br><span class="line">        end</span><br><span class="line">    end</span><br><span class="line">------for ik test---------</span><br><span class="line">--------------------------</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function sysCall_threadmain()</span><br><span class="line">    jointHandles=&#123;-1,-1,-1,-1,-1,-1,-1&#125;</span><br><span class="line">    for i=1,7,1 do</span><br><span class="line">        jointHandles[i]=sim.getObjectHandle(&apos;LBR4p_joint&apos;..i)</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    -- Set-up some of the RML vectors:</span><br><span class="line">    vel=110</span><br><span class="line">    accel=40</span><br><span class="line">    jerk=80</span><br><span class="line">    currentVel=&#123;0,0,0,0,0,0,0&#125;</span><br><span class="line">    currentAccel=&#123;0,0,0,0,0,0,0&#125;</span><br><span class="line">    maxVel=&#123;vel*math.pi/180,vel*math.pi/180,vel*math.pi/180,vel*math.pi/180,vel*math.pi/180,vel*math.pi/180,vel*math.pi/180&#125;</span><br><span class="line">    maxAccel=&#123;accel*math.pi/180,accel*math.pi/180,accel*math.pi/180,accel*math.pi/180,accel*math.pi/180,accel*math.pi/180,accel*math.pi/180&#125;</span><br><span class="line">    maxJerk=&#123;jerk*math.pi/180,jerk*math.pi/180,jerk*math.pi/180,jerk*math.pi/180,jerk*math.pi/180,jerk*math.pi/180,jerk*math.pi/180&#125;</span><br><span class="line">    targetVel=&#123;0,0,0,0,0,0,0&#125;</span><br><span class="line"></span><br><span class="line">    targetPos1=&#123;90*math.pi/180,90*math.pi/180,170*math.pi/180,90*math.pi/180,90*math.pi/180,90*math.pi/180,0&#125;</span><br><span class="line">    --sim.rmlMoveToJointPositions(jointHandles,-1,currentVel,currentAccel,maxVel,maxAccel,maxJerk,targetPos1,targetVel)</span><br><span class="line"></span><br><span class="line">    targetPos2=&#123;-90*math.pi/180,90*math.pi/180,180*math.pi/180,90*math.pi/180,90*math.pi/180,90*math.pi/180,0&#125;</span><br><span class="line">    --sim.rmlMoveToJointPositions(jointHandles,-1,currentVel,currentAccel,maxVel,maxAccel,maxJerk,targetPos2,targetVel)</span><br><span class="line"></span><br><span class="line">    targetPos3=&#123;0,0,0,0,0,0,0&#125;</span><br><span class="line">    --sim.rmlMoveToJointPositions(jointHandles,-1,currentVel,currentAccel,maxVel,maxAccel,maxJerk,targetPos3,targetVel)</span><br><span class="line">    </span><br><span class="line">    ikTest()</span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p>问题原因<br><code>sim.getConfigForTipPose</code>无法正常输出有效值的主要是因为该函数的<code>collisionPairs</code>参数没有正确设置的问题，开始时设置的碰撞对为kuka LBR4p机械臂本体和除开kuka LBR4p机械臂本体以外的物体：<img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_18.png" alt="pics1_18"><br>对应图中Collections的<code>LBR4p</code>和<code>not_LBR4p</code>。这样设置的问题是因为LBR4p机械臂安装在移动底盘上，移动底盘和机械臂之间也会进行碰撞检测，因此导致<code>sim.getConfigForTipPose</code>无法正常输出有效值。</p>
</li>
<li><p>解决办法<br>将机械臂和移动底盘整体设为一个collection，除外的部分设为另一个collection，对应图中Collections的<code>LBR4PP</code>和<code>not_LBR4PP</code>。此时<code>sim.getConfigForTipPose</code>可以正常输出对应的关节坐标。</p>
</li>
<li><p>其他问题：<br>开启碰撞检测功能后，即上图Calculation Modules中的collision功能，机械臂显示为碰撞状态，这是因为将机械臂和移动底盘检测为发生碰撞，此时可以考虑将基座连杆部分的碰撞属性取消，然后碰撞状态消失：<br><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_19.png" alt="pics1_19"></p>
</li>
</ul>
<h2 id="3-Vrep-b0通讯模式报错"><a href="#3-Vrep-b0通讯模式报错" class="headerlink" title="3.Vrep b0通讯模式报错"></a>3.Vrep b0通讯模式报错</h2><ul>
<li>问题描述：<blockquote>
<p>Traceback (most recent call last):<br>File “b0_drl.py”, line 111, in <module><br>  client.simxDefaultPublisher())<br>File “C:\Sam\Robotics\V-rep\Vrep_Python\python_b0\b0RemoteApi.py”, line 44, in <strong>exit</strong><br>  self._handleFunction(‘Ping’,[0],self.simxDefaultSubscriber(self._pingCallback))<br>File “C:\Sam\Robotics\V-rep\Vrep_Python\python_b0\b0RemoteApi.py”, line 118, in simxDefaultSubscriber<br>  self._handleFunction(‘setDefaultPublisherPubInterval’,[topic,publishInterval],channel)<br>File “C:\Sam\Robotics\V-rep\Vrep_Python\python_b0\b0RemoteApi.py”, line 70, in _handleFunction<br>  rep = msgpack.unpackb(self._serviceClient.call(packedData))<br>File “C:\Sam\Robotics\V-rep\Vrep_Python\python_b0\b0.py”, line 234, in call<br>  rep_bytes = bytearray(outarr.contents)<br>ValueError: NULL pointer access<br>2019-04-25 19:38:26 error: HB: Context was terminated</module></p>
</blockquote>
</li>
</ul>
<p>在<a href="http://www.forum.coppeliarobotics.com/viewtopic.php?f=5&amp;t=7858" target="_blank" rel="noopener">V-rep社区</a>提问后得到问题原因和解决办法：</p>
<ul>
<li>问题原因是： client端simxCallScriptFunction调用server端的函数时，server端被调用函数是阻塞型的，在<code>b0RemoteApi.py</code>的第25行<code>self._serviceClient.set_option(3,1000)</code>参数设置server在1000ms不返回数据就会报上述错误</li>
<li>所以解决办法是：将这一行代码里的参数进行修改，改为<code>self._serviceClient.set_option(3,25000) #read timeout of 1000ms</code>，然后就解决了上述问题。</li>
</ul>
<h2 id="4-Vrep动力学仿真的注意事项"><a href="#4-Vrep动力学仿真的注意事项" class="headerlink" title="4.Vrep动力学仿真的注意事项"></a>4.Vrep动力学仿真的注意事项</h2><p><a href="http://www.coppeliarobotics.com/helpFiles/en/designingDynamicSimulations.htm" target="_blank" rel="noopener">官方文档</a>关于动力学仿真实验设计：如果要使关节进行动力学仿真或者力传感器可以进行动力学仿真，必须要遵循一定的设计规则：<br><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_20.png" alt="pics1_20"></p>
<h2 id="5-关于sim-setJointPosition和sim-setJointTargetPosition的使用"><a href="#5-关于sim-setJointPosition和sim-setJointTargetPosition的使用" class="headerlink" title="5.关于sim.setJointPosition和sim.setJointTargetPosition的使用"></a>5.关于sim.setJointPosition和sim.setJointTargetPosition的使用</h2><p>sim.setJointPosition函数不能用于关节处于torque/force mode的模式，如果关节处于torque/force mode模式则sim.setJointPosition无效。在关节处于torque/force mode的模式时，使用sim.setJointTargetPosition控制关节转动，此时可以设置转动过程的控制参数，包括PID参数和速度限制。</p>
<h2 id="6-机械臂运动至目标点存在漂移的问题"><a href="#6-机械臂运动至目标点存在漂移的问题" class="headerlink" title="6.机械臂运动至目标点存在漂移的问题"></a>6.机械臂运动至目标点存在漂移的问题</h2><p>可能的原因：</p>
<ul>
<li>机械臂的关节工作在非torque/force mode模式，同时开启hybrid模式，此时可能由于重力原因机械臂发生漂移<br><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_21.png" alt="pics1_21"></li>
<li>thread script的主循环存在比较耗时的操作</li>
</ul>
<h2 id="7-vrep同步模式的基本知识"><a href="#7-vrep同步模式的基本知识" class="headerlink" title="7.vrep同步模式的基本知识"></a>7.vrep同步模式的基本知识</h2><ul>
<li>b0-based api：<a href="http://www.coppeliarobotics.com/helpFiles/en/b0RemoteApiOverview.htm" target="_blank" rel="noopener">http://www.coppeliarobotics.com/helpFiles/en/b0RemoteApiOverview.htm</a></li>
<li>child script：<a href="http://www.coppeliarobotics.com/helpFiles/en/childScripts.htm" target="_blank" rel="noopener">http://www.coppeliarobotics.com/helpFiles/en/childScripts.htm</a></li>
</ul>
<h2 id="8-vrep机械臂末端抖动的问题"><a href="#8-vrep机械臂末端抖动的问题" class="headerlink" title="8.vrep机械臂末端抖动的问题"></a>8.vrep机械臂末端抖动的问题</h2><p>该问题主要原因是：</p>
<ul>
<li>机械臂安装在移动底盘上，而移动底盘的车轮在仿真时有漂移现象发生，所以导致机械臂一直在抖动。</li>
<li>不同的物理仿真引擎也会导致这种情况出现，使用Bullet 2.78引擎时，抖动现象最弱。</li>
</ul>
<h2 id="9-vrep存在有的逆解路径无法到达的问题"><a href="#9-vrep存在有的逆解路径无法到达的问题" class="headerlink" title="9.vrep存在有的逆解路径无法到达的问题"></a>9.vrep存在有的逆解路径无法到达的问题</h2><p>可能是因为使用伪逆法求逆解得到的路径在奇异点附近运行困难。<br>但是换成数值解法之后无法得到有效解。<br>TODO：待解决上述问题。</p>
<h2 id="10-初始仿真时物体属性设置的一些tricks"><a href="#10-初始仿真时物体属性设置的一些tricks" class="headerlink" title="10.初始仿真时物体属性设置的一些tricks"></a>10.初始仿真时物体属性设置的一些tricks</h2><p><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_22.png" alt="pics1_22"><br>如上图的场景，想要初始状态是吸盘吸取物体。如果物体属性设置为“Body is dynamic”，仿真开始的一瞬间物体就会掉落下去，下图是物体的初始属性：<br><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_23.png" alt="pics1_23"></p>
<p>查看官方文档后，发现<code>Start in sleep mode</code>和<code>Set to dynamic if gets parent</code>这两个属性很有用，官方解释：<br><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_24.png" alt="pics1_24"></p>
<ul>
<li>Start in sleep mode：该选项使能时，dynamic物体初始时处于不响应模式（不响应重力作用），直到与其他响应物体发生碰撞</li>
<li>Set to dynamic if gets parent：该模式使能时，只有当该物体设置连接至另一个物体是，才使能该物体为dynamic。。这个属性非常适合和吸盘配合，吸盘吸取物体时就是将被吸取物体设置为吸盘的子物体。</li>
</ul>
<p>勾选上述两个设置后，仿真开始后物体就不会掉落，移动机械臂吸取物体后，物体将使能dynamic属性，然后就可以进行动力学仿真。</p>
<p>上述方法仍然可能存在如下问题：在吸盘接触物体的一瞬间物体变为”dynamic”，吸盘没有吸取到物体时物体就掉落。<br>解决该问题的小trick：在物体下方添加一个小立方体来支撑物体，将其dynamic属性取消，并设置为透明，设置如下：<br><img src="https://raw.githubusercontent.com/doctorsrn/git_test/master/picture_blog/pics_vrep/pics1_25.png" alt="pics1_25"><br>当吸盘成功吸取物体后移开该立方体，可以重设该立方体的位置即可：示例命令<code>sim.setObjectPosition(190,-1,{0.6,0.6,0.5})</code></p>
<h1 id="四、基于V-rep模仿OpenAI-Gym搭建V-rep强化学习环境"><a href="#四、基于V-rep模仿OpenAI-Gym搭建V-rep强化学习环境" class="headerlink" title="四、基于V-rep模仿OpenAI Gym搭建V-rep强化学习环境"></a>四、基于V-rep模仿OpenAI Gym搭建V-rep强化学习环境</h1><p>基于V-rep模仿OpenAI Gym搭建V-rep强化学习环境，所实现的代码放置于代码仓库<a href="https://github.com/doctorsrn/gym_vrep" target="_blank" rel="noopener">gym_vrep</a>.使用强化学习方法主要来解决双臂机器人在板材安装过程中压紧过程的规划和控制问题。</p>
<h2 id="1-遵照OpenGym环境的格式搭建V-rep强化学习环境"><a href="#1-遵照OpenGym环境的格式搭建V-rep强化学习环境" class="headerlink" title="1.遵照OpenGym环境的格式搭建V-rep强化学习环境"></a>1.遵照OpenGym环境的格式搭建V-rep强化学习环境</h2><p>参考示例：</p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/33553076" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/33553076</a></li>
<li><a href="https://github.com/openai/gym-soccer" target="_blank" rel="noopener">https://github.com/openai/gym-soccer</a></li>
<li><a href="https://github.com/apoddar573/Tic-Tac-Toe-Gym_Environment" target="_blank" rel="noopener">https://github.com/apoddar573/Tic-Tac-Toe-Gym_Environment</a></li>
</ul>
<p>主要是自定义<code>__init__(),step(),reset(),render(),close()</code>等函数。</p>
<h2 id="2-windows下tensorboard使用"><a href="#2-windows下tensorboard使用" class="headerlink" title="2.windows下tensorboard使用"></a>2.windows下tensorboard使用</h2><p>出现<code>tensorboard 无法访问此网站</code>的问题，将tensorboard的网址改成：<code>http://localhost:6006/</code>即可正常访问。</p>
<p>参考：<a href="https://blog.csdn.net/wangqi_qiangku/article/details/79835801" target="_blank" rel="noopener">https://blog.csdn.net/wangqi_qiangku/article/details/79835801</a></p>
<h2 id="3-加速Vrep仿真的方法"><a href="#3-加速Vrep仿真的方法" class="headerlink" title="3.加速Vrep仿真的方法"></a>3.加速Vrep仿真的方法</h2><p>1) 将仿真时间步调大。<br>参考：</p>
<ul>
<li><a href="http://www.forum.coppeliarobotics.com/viewtopic.php?f=9&amp;t=2247" target="_blank" rel="noopener">http://www.forum.coppeliarobotics.com/viewtopic.php?f=9&amp;t=2247</a></li>
<li><a href="http://www.coppeliarobotics.com/helpFiles/en/simulation.htm" target="_blank" rel="noopener">http://www.coppeliarobotics.com/helpFiles/en/simulation.htm</a> </li>
<li>仿真设置界面：<a href="http://www.coppeliarobotics.com/helpFiles/en/simulationPropertiesDialog.htm" target="_blank" rel="noopener">http://www.coppeliarobotics.com/helpFiles/en/simulationPropertiesDialog.htm</a></li>
</ul>
<p>2) 关闭图像引擎，使用<a href="http://www.coppeliarobotics.com/helpFiles/en/commandLine.htm" target="_blank" rel="noopener">命令行模式</a></p>
<ul>
<li><a href="http://www.forum.coppeliarobotics.com/viewtopic.php?t=7" target="_blank" rel="noopener">http://www.forum.coppeliarobotics.com/viewtopic.php?t=7</a></li>
<li><a href="http://www.forum.coppeliarobotics.com/viewtopic.php?t=6359" target="_blank" rel="noopener">http://www.forum.coppeliarobotics.com/viewtopic.php?t=6359</a><br>可以使用如下命令关闭图像引擎的渲染：<code>simSetBooleanParameter(sim_boolparam_display_enabled,false)</code></li>
</ul>
<p>3) 开启单独的图像引擎线程</p>
<ul>
<li><a href="http://www.coppeliarobotics.com/helpFiles/en/simulation.htm" target="_blank" rel="noopener">http://www.coppeliarobotics.com/helpFiles/en/simulation.htm</a></li>
<li>仿真属性设置：<a href="http://www.coppeliarobotics.com/helpFiles/en/simulationPropertiesDialog.htm" target="_blank" rel="noopener">http://www.coppeliarobotics.com/helpFiles/en/simulationPropertiesDialog.htm</a></li>
</ul>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="1-贝塞尔曲线的解释"><a href="#1-贝塞尔曲线的解释" class="headerlink" title="1. 贝塞尔曲线的解释"></a>1. 贝塞尔曲线的解释</h2><p>1) <a href="http://www.html-js.com/article/1628" target="_blank" rel="noopener">讲解</a><br>2) <a href="http://myst729.github.io/bezier-curve/" target="_blank" rel="noopener">在线仿真</a><br>3) <a href="https://www.xuanfengge.com/cubic-bezier-bezier-css3-animation-tools.html" target="_blank" rel="noopener">前端应用</a></p>
<h2 id="2-3维绘图软件"><a href="#2-3维绘图软件" class="headerlink" title="2. 3维绘图软件"></a>2. 3维绘图软件</h2><p><a href="https://www.autodesk.com.cn/products/inventor/overview" target="_blank" rel="noopener">inventor</a>：Autodesk公司出品，可以用来绘制机械臂3维模型。</p>

      
    </div>
    
    
    
    
    <div>
     
       <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------The End<i class="fa fa-paw"></i>Thanks for reading!-------------</div>
    
</div>

     
    </div>     


    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    SamLiu
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://doctorsrn.cn/2019/08/02/V-rep/" title="V-rep机器人仿真软件使用的学习笔记">http://doctorsrn.cn/2019/08/02/V-rep/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/python/" rel="tag"><i class="fa fa-tag"></i> python</a>
          
            <a href="/tags/robotics/" rel="tag"><i class="fa fa-tag"></i> robotics</a>
          
            <a href="/tags/simulation/" rel="tag"><i class="fa fa-tag"></i> simulation</a>
          
            <a href="/tags/v-rep/" rel="tag"><i class="fa fa-tag"></i> v-rep</a>
          
            <a href="/tags/lua/" rel="tag"><i class="fa fa-tag"></i> lua</a>
          
            <a href="/tags/deep-reinforcement-learning/" rel="tag"><i class="fa fa-tag"></i> deep reinforcement learning</a>
          
        </div>
      

      
      
        <div class="post-widgets">
        

        

        
          
          <div id="needsharebutton-postbottom">
            <span class="btn">
              <i class="fa fa-share-alt" aria-hidden="true"></i>
            </span>
          </div>
        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/08/01/sort_algorithm/" rel="next" title="十大排序算法练习">
                <i class="fa fa-chevron-left"></i> 十大排序算法练习
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/08/08/CodingInterviewChinese2/" rel="prev" title="《剑指offer》 刷题记录">
                《剑指offer》 刷题记录 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://raw.githubusercontent.com/doctorsrn/git_test/master/050.jpg" alt="SamLiu">
            
              <p class="site-author-name" itemprop="name">SamLiu</p>
              <p class="site-description motion-element" itemprop="description">Just see the blog.I love my girlfriend.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/doctorsrn" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#一、V-rep-基本知识"><span class="nav-text">一、V-rep 基本知识</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Tutorials-Building-a-clean-model-tutorial"><span class="nav-text">1.Tutorials: Building a clean model tutorial</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-Building-the-visible-shapes"><span class="nav-text">1.1 Building the visible shapes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-Building-the-joints"><span class="nav-text">1.2 Building the joints</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-Building-the-dynamic-shapes"><span class="nav-text">1.3 Building the dynamic shapes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-Model-definition"><span class="nav-text">1.4 Model definition</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-关于V-rep内置Lua脚本的学习"><span class="nav-text">2.关于V-rep内置Lua脚本的学习</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-main-script"><span class="nav-text">2.1 main script</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-child-scripts"><span class="nav-text">2.2 child scripts</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-non-threaded-child-scripts"><span class="nav-text">2.2.1 non-threaded child scripts</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-2-threaded-child-scripts"><span class="nav-text">2.2.2 threaded child scripts</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-Script-simulation-parameters"><span class="nav-text">2.3 Script simulation parameters</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-Customization-scripts"><span class="nav-text">2.4 Customization scripts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-Callback-functions"><span class="nav-text">2.5 Callback functions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-Script-dialog"><span class="nav-text">2.5 Script dialog</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-Script-execution-order"><span class="nav-text">2.6 Script execution order</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-遇到的Vrep中Python-Api函数—-gt-属于client端的远程API函数"><span class="nav-text">3.遇到的Vrep中Python Api函数—&gt;属于client端的远程API函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-遇到的Vrep中Lua-Api函数—-gt-属于server端的常规API函数，在Regular-API目录下查找API文档"><span class="nav-text">4.遇到的Vrep中Lua Api函数—&gt;属于server端的常规API函数，在Regular API目录下查找API文档</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Vrep中子脚本线程执行"><span class="nav-text">5.Vrep中子脚本线程执行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Vrep中路径规划的两种情况"><span class="nav-text">6.Vrep中路径规划的两种情况</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-关于Vrep自带模型的D-H参数获取的办法"><span class="nav-text">7.关于Vrep自带模型的D-H参数获取的办法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-远程API-工作方式分析-官方文档"><span class="nav-text">8.远程API)工作方式分析(官方文档)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-Vrep中关节不同的属性"><span class="nav-text">9.Vrep中关节不同的属性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-Vrep中仿真过程不同状态的介绍"><span class="nav-text">10.Vrep中仿真过程不同状态的介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-参考网站"><span class="nav-text">11.参考网站</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二、V-rep进阶知识点"><span class="nav-text">二、V-rep进阶知识点</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-vrep使用b0RemoteApi工作模式"><span class="nav-text">1. vrep使用b0RemoteApi工作模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-0-Vrep-b0RemoteApi工作模式解析"><span class="nav-text">1.0 Vrep b0RemoteApi工作模式解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-vrep-b0RemoteApi工作模式下API之间的关系："><span class="nav-text">1.1 vrep b0RemoteApi工作模式下API之间的关系：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-vrep中吸盘工具suction-pad的使用"><span class="nav-text">2. vrep中吸盘工具suction pad的使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-vrep中力-力矩传感器（force-sensor）的使用"><span class="nav-text">3. vrep中力/力矩传感器（force sensor）的使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Vrep中不同物理仿真引擎的使用"><span class="nav-text">4. Vrep中不同物理仿真引擎的使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-使用Vrep控制实物机器人的思路"><span class="nav-text">5. 使用Vrep控制实物机器人的思路</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-使用Reflexxes-Motion-Library（在线运动轨迹生成库）进行轨迹规划"><span class="nav-text">6. 使用Reflexxes Motion Library（在线运动轨迹生成库）进行轨迹规划</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-vrep不同类型的刚体表示，作用不同"><span class="nav-text">7.vrep不同类型的刚体表示，作用不同</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三、V-rep在机械臂仿真中遇到的一些问题"><span class="nav-text">三、V-rep在机械臂仿真中遇到的一些问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-vrep机械臂散架问题"><span class="nav-text">1.vrep机械臂散架问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Vrep逆运动学解算，使用sim-getConfigForTipPose函数输出结果为nil的问题"><span class="nav-text">2.Vrep逆运动学解算，使用sim.getConfigForTipPose函数输出结果为nil的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Vrep-b0通讯模式报错"><span class="nav-text">3.Vrep b0通讯模式报错</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Vrep动力学仿真的注意事项"><span class="nav-text">4.Vrep动力学仿真的注意事项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-关于sim-setJointPosition和sim-setJointTargetPosition的使用"><span class="nav-text">5.关于sim.setJointPosition和sim.setJointTargetPosition的使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-机械臂运动至目标点存在漂移的问题"><span class="nav-text">6.机械臂运动至目标点存在漂移的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-vrep同步模式的基本知识"><span class="nav-text">7.vrep同步模式的基本知识</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-vrep机械臂末端抖动的问题"><span class="nav-text">8.vrep机械臂末端抖动的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-vrep存在有的逆解路径无法到达的问题"><span class="nav-text">9.vrep存在有的逆解路径无法到达的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-初始仿真时物体属性设置的一些tricks"><span class="nav-text">10.初始仿真时物体属性设置的一些tricks</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四、基于V-rep模仿OpenAI-Gym搭建V-rep强化学习环境"><span class="nav-text">四、基于V-rep模仿OpenAI Gym搭建V-rep强化学习环境</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-遵照OpenGym环境的格式搭建V-rep强化学习环境"><span class="nav-text">1.遵照OpenGym环境的格式搭建V-rep强化学习环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-windows下tensorboard使用"><span class="nav-text">2.windows下tensorboard使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-加速Vrep仿真的方法"><span class="nav-text">3.加速Vrep仿真的方法</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#附录"><span class="nav-text">附录</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-贝塞尔曲线的解释"><span class="nav-text">1. 贝塞尔曲线的解释</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3维绘图软件"><span class="nav-text">2. 3维绘图软件</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">SamLiu</span>

  
</div>

<div>
<a href="http://www.miitbeian.gov.cn/">陕ICP备16008972号</a> 
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'jQxFkr8U9EDRbCqLEKgx0kO1-gzGzoHsz',
        appKey: 'YCVKL4J0cJ0zfYLiUXdEopPe',
        placeholder: 'ヾﾉ≧∀≦)o Just say something.',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("jQxFkr8U9EDRbCqLEKgx0kO1-gzGzoHsz", "YCVKL4J0cJ0zfYLiUXdEopPe");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "box";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

  

  
  


  

  

</body>
</html>
